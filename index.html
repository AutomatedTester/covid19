<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="javascript/covid19.js"></script>
<script src="javascript/layout.js"></script>
<link rel="stylesheet" href="css/covid19.css">
<div id=lastUpdated></div>
<script>
    update().then(d => {
        let data = d.data;
        let dates = data.map(obj => {
            return obj.date;
        });

        lastDate = dates[0];
        document.getElementById("lastUpdated").innerText = `Last updated: ${lastDate}`;

        let deaths = data.map(obj => {
            return obj.deathsDaily;
        });

        let casesBySpecimenDate = data.map(obj => {
            return obj.casesBySpecimenDate;
        });

        let casesDaily = data.map(obj => {
            return obj.casesDaily;
        })

        let hospitalCases = data.map(obj => {
            return obj.hospitalCases;
        });

        let covidOccupiedMVBeds = data.map(obj => {
            return obj.covidOccupiedMVBeds;
        });

        let eatOutStart = [0, Math.max(...casesBySpecimenDate)]

        let layout = {
            title: 'England Covid Data',
            shapes: [
                {
                    name: "First Lockdown",
                    type: "line",
                    x0: '2020-03-23',
                    y0: 0,
                    x1: '2020-03-23',
                    yref: 'paper',
                    y1: 1,
                    line: {
                        color: 'grey',
                        width: 1.5,
                        dash: 'dot'
                    }
                },
                {
                    name: "Eat out to help out starts",
                    type: "line",
                    x0: '2020-08-03',
                    y0: 0,
                    x1: '2020-08-03',
                    yref: 'paper',
                    y1: 1,
                    line: {
                        color: 'grey',
                        width: 1.5,
                        dash: 'dot'
                    }
                },
                {
                    name: "Eat out to help out ends",
                    type: "line",
                    x0: '2020-08-03',
                    y0: 0,
                    x1: '2020-08-03',
                    yref: 'paper',
                    y1: 1,
                    line: {
                        color: 'grey',
                        width: 1.5,
                        dash: 'dot'
                    }
                },
                {
                    name: "Schools Return",
                    type: "line",
                    x0: '2020-09-03',
                    y0: 0,
                    x1: '2020-09-03',
                    yref: 'paper',
                    y1: 1,
                    line: {
                        color: 'grey',
                        width: 1.5,
                        dash: 'dot'
                    }
                },
                {
                    name: "Second Lockdown",
                    type: "line",
                    x0: '2020-11-05',
                    y0: 0,
                    x1: '2020-11-05',
                    yref: 'paper',
                    y1: 1,
                    line: {
                        color: 'grey',
                        width: 1.5,
                        dash: 'dot'
                    }
                }
            ],
            annotations: [
                {
                    x: "2020-03-23",
                    y: Math.max(...casesBySpecimenDate) - 10,
                    xref: 'x',
                    yref: 'y',
                    text: 'First Lockdown',
                    showarrow: true,
                    arrowhead: 7,
                    ax: 10,
                    ay: -40
                },
                {
                    x: "2020-08-03",
                    y: Math.max(...casesBySpecimenDate) - 10,
                    xref: 'x',
                    yref: 'y',
                    text: 'Eat out to help out starts',
                    showarrow: true,
                    arrowhead: 7,
                    ax: 10,
                    ay: -40
                },
                {
                    x: "2020-08-31",
                    y: Math.max(...casesBySpecimenDate) - 10,
                    xref: 'x',
                    yref: 'y',
                    text: 'Eat out to help out ends',
                    showarrow: true,
                    arrowhead: 7,
                    ax: 10,
                    ay: -20
                },
                {
                    x: "2020-09-03",
                    y: Math.max(...casesBySpecimenDate) - 10,
                    xref: 'x',
                    yref: 'y',
                    text: 'Schools Return',
                    showarrow: true,
                    arrowhead: 7,
                    ax: 10,
                    ay: 40
                },
                {
                    x: "2020-11-05",
                    y: Math.max(...casesBySpecimenDate) - 10,
                    xref: 'x',
                    yref: 'y',
                    text: 'Second lockdown',
                    showarrow: true,
                    arrowhead: 7,
                    ax: 10,
                    ay: -40
                }
            ]
        };

        let config = {
            responsive: true,
            scrollZoom: true,
        }

        let plot = [
            { x: dates, y: deaths, type: 'scatter', mode: "lines", name: "Deaths", fill: 'tozeroy' },
            { x: dates, y: casesBySpecimenDate, type: "scatter", mode: "lines", name: "Cases by Specimen date", fill: 'tozeroy' },
            { x: dates, y: casesDaily, type: "scatter", mode: "lines", name: "Cases Reported Daily", fill: "tozeroy" },
            { x: dates, y: hospitalCases, type: "scatter", mode: "lines", name: "Hospital Cases", fill: 'tozeroy' },
            { x: dates, y: covidOccupiedMVBeds, type: "scatter", mode: "lines", name: "Occupied ITU Bed", fill: 'tozeroy' }
        ];

        Plotly.newPlot('myDiv', plot, layout, config);

        let table = document.querySelector("table");
        let keys = Object.keys(data[0]);
        generateTableHead(table, keys);
        generateTable(table, data.slice(0, 7));
    });
</script>

<div id=myDiv></div>

<table></table>
